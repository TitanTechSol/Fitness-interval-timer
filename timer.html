<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FIT</title>
<style>
  :root { 
    font-family: system-ui, sans-serif;
    /* Default Dark Theme */
    --bg-primary: #0f172a;
    --bg-secondary: #111827;
    --bg-tertiary: #1f2937;
    --text-primary: #e2e8f0;
    --text-secondary: #9ca3af;
    --text-accent: #93c5fd;
    --border: #334155;
    --border-light: #223;
    --shadow: rgba(0,0,0,.35);
    --warn: #fca5a5;
  }
  
  /* Light Theme */
  .theme-light {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-accent: #3b82f6;
    --border: #cbd5e1;
    --border-light: #e2e8f0;
    --shadow: rgba(0,0,0,.1);
    --warn: #dc2626;
  }
  
  /* Blue Theme */
  .theme-blue {
    --bg-primary: #0c1222;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-accent: #60a5fa;
    --border: #475569;
    --border-light: #334155;
    --shadow: rgba(59,130,246,.2);
    --warn: #f87171;
  }
  
  /* Yellow Theme */
  .theme-yellow {
    --bg-primary: #1c1917;
    --bg-secondary: #292524;
    --bg-tertiary: #44403c;
    --text-primary: #fef3c7;
    --text-secondary: #d6d3d1;
    --text-accent: #fbbf24;
    --border: #57534e;
    --border-light: #44403c;
    --shadow: rgba(251,191,36,.2);
    --warn: #f59e0b;
  }
  
  /* Orange Theme */
  .theme-orange {
    --bg-primary: #1c1917;
    --bg-secondary: #292524;
    --bg-tertiary: #44403c;
    --text-primary: #fed7aa;
    --text-secondary: #d6d3d1;
    --text-accent: #fb923c;
    --border: #57534e;
    --border-light: #44403c;
    --shadow: rgba(251,146,60,.2);
    --warn: #ea580c;
  }
  
  body { 
    display:flex; 
    min-height:100svh; 
    align-items:center; 
    justify-content:center; 
    background:var(--bg-primary); 
    color:var(--text-primary); 
    margin:0; 
    padding:0; 
    overflow:hidden; 
  }
  .main-card { position: relative; background:var(--bg-secondary); padding:24px; border-radius:16px; box-shadow: 0 8px 30px var(--shadow); width:500px; overflow:hidden; }
  h1 { margin:0 0 10px; font-size:1.15rem; color:var(--text-accent); font-weight:600; }
  .time { font-variant-numeric: tabular-nums; font-size:3.2rem; text-align:center; margin:6px 0 12px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  button, input, select { font:inherit; padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--bg-tertiary); color:var(--text-primary); }
  button:hover { filter:brightness(1.1); cursor:pointer; }
  .settings-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; padding: 6px; font-size: 16px; display: flex; align-items: center; justify-content: center; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--bg-primary); border:1px solid var(--border-light); color:var(--text-secondary); font-size:.9rem; }
  .muted { opacity:.75 }
  .stack { display:grid; gap:8px; }
  .footer { margin-top:10px; display:flex; justify-content:space-between; align-items:center; font-size:.9rem; color:var(--text-secondary); }
  .warn { color:var(--warn); }
  .settings-nav { display: flex; gap: 8px; margin-bottom: 16px; }
  .nav-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; }
  .nav-btn.active { background: var(--text-accent); color: var(--bg-primary); }
  .settings-page { display: none; }
  .settings-page.active { display: block; }
  .slider-control { display: flex; align-items: center; gap: 12px; padding: 8px 12px; border-radius: 8px; background: var(--bg-primary); border: 1px solid var(--border); }
  .slider-switch { position: relative; width: 44px; height: 24px; background: var(--border); border-radius: 12px; cursor: pointer; transition: background 0.3s; }
  .slider-switch.active { background: var(--text-accent); }
  .slider-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s; }
  .slider-switch.active::after { transform: translateX(20px); }
  .drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; margin: 8px 0; }
  .drop-zone:hover, .drop-zone.drag-over { border-color: var(--text-accent); background: var(--bg-primary); }
  .drop-zone.has-files { border-color: var(--text-accent); background: var(--bg-primary); }
  .audio-count-selector { width: 80px; }
  .time-input-group { display: flex; align-items: center; gap: 4px; }
  .time-input { width: 3rem; text-align: center; }
  .time-label { font-size: 0.85rem; color: var(--text-secondary); }
  .random-range { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .volume-slider { width: 120px; }
  .help-section { background:var(--bg-primary); padding:16px; border-radius:8px; margin-top:12px; border:1px solid var(--border); }
  .help-section h3 { margin:0 0 8px; font-size:.95rem; color:var(--text-accent); }
  .help-section p { margin:0 0 8px; font-size:.85rem; line-height:1.4; }
  .help-section ol { margin:0; padding-left:20px; font-size:.85rem; line-height:1.4; }
  .theme-selector { width: 140px; }
    
    /* Notification animations */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
</style>
</head>
<body>
  <div class="main-card">
    <button id="settings" class="settings-btn">⚙️</button>
    
    <!-- Main Timer View -->
    <div id="mainView">
      <h1>FIT</h1>
      <div class="time" id="display">10:00</div>
      <div class="stack">
        <div class="row">
          <button id="start">Start</button>
          <button id="pause" disabled>Pause</button>
          <button id="stop">Stop</button>
        </div>
      </div>
      <div class="footer">
        <div>Intervals completed: <strong id="laps">0</strong></div>
        <div class="muted">Reset all, resets the counter.</div>
      </div>
    </div>

    <!-- Settings View -->
    <div id="settingsView" style="display: none;">
      <h1>Settings</h1>
      
      <!-- Settings Navigation -->
      <div class="settings-nav">
        <button class="nav-btn active" data-page="timer">Timer</button>
        <button class="nav-btn" data-page="audio">Audio</button>
      </div>
      
      <!-- Timer Settings Page -->
      <div id="timerPage" class="settings-page active">
        <div class="stack" style="margin-top: 20px;">
          <div class="row">
            <span class="pill">
              Length:
              <div class="time-input-group">
                <input id="hours" type="number" min="0" max="23" value="0" class="time-input" />
                <span class="time-label">h</span>
                <input id="minutes" type="number" min="0" max="59" value="10" class="time-input" />
                <span class="time-label">m</span>
                <input id="seconds" type="number" min="0" max="59" value="0" class="time-input" />
                <span class="time-label">s</span>
              </div>
            </span>
          </div>
          
          <div class="slider-control">
            <span>Random time between:</span>
            <div class="slider-switch active" id="randomModeSwitch"></div>
          </div>
          
          <div id="randomRangeInputs" class="row">
            <span class="pill">
              <div class="random-range">
                <div class="time-input-group">
                  <input id="randomMinHours" type="number" min="0" max="23" value="0" class="time-input" />
                  <span class="time-label">h</span>
                  <input id="randomMinMinutes" type="number" min="0" max="59" value="7" class="time-input" />
                  <span class="time-label">m</span>
                  <input id="randomMinSeconds" type="number" min="0" max="59" value="0" class="time-input" />
                  <span class="time-label">s</span>
                </div>
                <span>-</span>
                <div class="time-input-group">
                  <input id="randomMaxHours" type="number" min="0" max="23" value="0" class="time-input" />
                  <span class="time-label">h</span>
                  <input id="randomMaxMinutes" type="number" min="0" max="59" value="12" class="time-input" />
                  <span class="time-label">m</span>
                  <input id="randomMaxSeconds" type="number" min="0" max="59" value="0" class="time-input" />
                  <span class="time-label">s</span>
                </div>
              </div>
            </span>
          </div>
          
          <div class="slider-control">
            <span>Sound</span>
            <div class="slider-switch active" id="soundSwitch"></div>
          </div>
          
          <div class="slider-control">
            <span>Desktop notifications</span>
            <div class="slider-switch" id="notifySwitch"></div>
          </div>
          
          <div class="slider-control">
            <span>Always on top</span>
            <div class="slider-switch" id="alwaysOnTopSwitch"></div>
          </div>
          
          <div class="row">
            <span class="pill">
              Volume:
              <input id="volumeSlider" type="range" min="0" max="100" value="100" class="volume-slider" />
              <span id="volumeDisplay">100%</span>
            </span>
          </div>
          
          <div class="row">
            <span class="pill">
              Theme:
              <select id="themeSelector" class="theme-selector">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="blue">Blue</option>
                <option value="yellow">Yellow</option>
                <option value="orange">Orange</option>
              </select>
            </span>
          </div>
          
          <div class="row">
            <button id="reset">Reset All</button>
          </div>
        </div>
      </div>
      
      <!-- Audio Settings Page -->
      <div id="audioPage" class="settings-page">
        <div class="stack" style="margin-top: 20px;">
          <div class="row">
            <span class="pill">
              Audio Count:
              <select id="audioCountSelector" class="audio-count-selector">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
              </select>
            </span>
          </div>
          
          <div class="drop-zone" id="audio1DropZone">
            <h4>Audio 1 - "What are you doing?"</h4>
            <p>Drop your main prompt audio file here (.mp3)</p>
            <small id="audio1Status">Current: Audio1.mp3</small>
          </div>
          
          <div class="drop-zone" id="audio2DropZone">
            <h4>Audio 2 - Situation (Random)</h4>
            <p>Drop situation audio files here (.mp3)</p>
            <small id="audio2Status">Current: Multiple files</small>
          </div>
          
          <div class="drop-zone" id="audio3DropZone">
            <h4>Audio 3 - Action (Random)</h4>
            <p>Drop action/workout audio files here (.mp3)</p>
            <small id="audio3Status">Current: Multiple files</small>
          </div>
          
          <div class="drop-zone" id="audio4DropZone">
            <h4>Audio 4 - Extra (Random)</h4>
            <p>Drop additional audio files here (.mp3)</p>
            <small id="audio4Status">Current: Empty</small>
          </div>
          
          <div class="row">
            <button id="testAudio">Test Audio Sequence</button>
            <button id="restoreBackup">Restore Backup Audios</button>
            <button id="openSoundsFolder">Open Audio Folder</button>
          </div>
          
          <div class="help-section">
            <h3>🎵 Audio Configuration Guide</h3>
            <p><strong>Audio Sequence:</strong> The timer plays 1-4 audio files in sequence based on your selection.</p>
            <ol>
              <li><strong>Audio 1:</strong> Main prompt (single file) - "What are you doing?"</li>
              <li><strong>Audio 2:</strong> Situation context (random from folder) - "If you are sitting"</li>
              <li><strong>Audio 3:</strong> Action command (random from folder) - "Do 10 pushups"</li>
              <li><strong>Audio 4:</strong> Optional extra content (random from folder)</li>
            </ol>
            <p><strong>Drag & Drop:</strong> Simply drag .mp3 files into the drop zones above.</p>
            <p><strong>Backup:</strong> Original audio files are safely stored and can be restored anytime.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No audio elements needed - we create them dynamically -->

<script>
(() => {
  // No need to require electron - using preload script
  
  const display = document.getElementById('display');
  const lapsEl = null; // Not used in current version
  const startBtn= document.getElementById('start');
  const pauseBtn= document.getElementById('pause');
  const stopBtn = document.getElementById('stop');
  const settingsBtn = document.getElementById('settings');
  const mainView = document.getElementById('mainView');
  const settingsView = document.getElementById('settingsView');
  const resetBtn= document.getElementById('reset');
  
  // Settings navigation
  const timerPage = document.getElementById('timerPage');
  const audioPage = document.getElementById('audioPage');
  const navBtns = document.querySelectorAll('.nav-btn');
  
  // Time input elements
  const hoursInp = document.getElementById('hours');
  const minsInp = document.getElementById('minutes');
  const secsInp = document.getElementById('seconds');
  
  // Random range elements
  const randomModeSwitch = document.getElementById('randomModeSwitch');
  const randomRangeInputs = document.getElementById('randomRangeInputs');
  const randomMinHours = document.getElementById('randomMinHours');
  const randomMinMinutes = document.getElementById('randomMinMinutes');
  const randomMinSeconds = document.getElementById('randomMinSeconds');
  const randomMaxHours = document.getElementById('randomMaxHours');
  const randomMaxMinutes = document.getElementById('randomMaxMinutes');
  const randomMaxSeconds = document.getElementById('randomMaxSeconds');
  
  // Slider switches
  const soundSwitch = document.getElementById('soundSwitch');
  const notifySwitch = document.getElementById('notifySwitch');
  const alwaysOnTopSwitch = document.getElementById('alwaysOnTopSwitch');
  
  // Other controls
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeDisplay = document.getElementById('volumeDisplay');
  const themeSelector = document.getElementById('themeSelector');
  
  // Audio controls
  const audioCountSelector = document.getElementById('audioCountSelector');
  const testAudioBtn = document.getElementById('testAudio');
  const restoreBackupBtn = document.getElementById('restoreBackup');
  const openSoundsFolderBtn = document.getElementById('openSoundsFolder');
  
  // Drop zones for drag-and-drop
  const audio1DropZone = document.getElementById('audio1DropZone');
  const audio2DropZone = document.getElementById('audio2DropZone');
  const audio3DropZone = document.getElementById('audio3DropZone');
  const audio4DropZone = document.getElementById('audio4DropZone');

  let totalSec = 10 * 60;     // default 10 min
  let remaining = totalSec;
  let timer = null;
  let laps = 0;
  let masterVolume = 1.0; // 0.0 to 1.0
  
  // Audio elements
  let audio1 = null;    // Single file
  let audio2 = null;    // Random from folder
  let audio3 = null;    // Random from folder  
  let audio4 = null;    // Random from folder
  
  // Settings object to store all preferences with new defaults
  const settings = {
    hours: 0,
    minutes: 7,  // Changed from 10 to 7 for default random range
    seconds: 0,
    randomMode: true,  // Changed to true by default
    randomMinHours: 0,
    randomMinMinutes: 7,
    randomMinSeconds: 0,
    randomMaxHours: 0,
    randomMaxMinutes: 12,
    randomMaxSeconds: 0,
    sound: true,
    notify: false,    // Changed to false by default
    alwaysOnTop: false,
    volume: 100,
    theme: 'dark',
    audioCount: 3     // New setting for audio sequence count
  };
  
  // Dynamically load audio files from folders using Node.js
  const fs = require('fs');
  const path = require('path');
  let audio2Files = [];
  let audio3Files = [];
  let audio4Files = [];

  // Load and save settings to localStorage
  function loadSettings() {
    const saved = localStorage.getItem('fitTimerSettings');
    if (saved) {
      Object.assign(settings, JSON.parse(saved));
      applySettings();
    }
  }
  
  function saveSettings() {
    localStorage.setItem('fitTimerSettings', JSON.stringify(settings));
  }
  
  function applySettings() {
    hoursInp.value = settings.hours;
    minsInp.value = settings.minutes;
    secsInp.value = settings.seconds;
    
    // Apply slider switches
    randomModeSwitch.classList.toggle('active', settings.randomMode);
    soundSwitch.classList.toggle('active', settings.sound);
    notifySwitch.classList.toggle('active', settings.notify);
    alwaysOnTopSwitch.classList.toggle('active', settings.alwaysOnTop);
    
    // Random range inputs
    randomMinHours.value = settings.randomMinHours;
    randomMinMinutes.value = settings.randomMinMinutes;
    randomMinSeconds.value = settings.randomMinSeconds;
    randomMaxHours.value = settings.randomMaxHours;
    randomMaxMinutes.value = settings.randomMaxMinutes;
    randomMaxSeconds.value = settings.randomMaxSeconds;
    
    // Other controls
    volumeSlider.value = settings.volume;
    themeSelector.value = settings.theme;
    audioCountSelector.value = settings.audioCount;
    
    // Show/hide random range inputs
    randomRangeInputs.style.display = settings.randomMode ? 'flex' : 'none';
    
    // Apply volume
    masterVolume = settings.volume / 100;
    volumeDisplay.textContent = settings.volume + '%';
    
    // Apply theme
    document.body.className = settings.theme === 'dark' ? '' : `theme-${settings.theme}`;
    
    // Apply always on top
    if (window.electronAPI) {
      window.electronAPI.setAlwaysOnTop(settings.alwaysOnTop);
    }
  }
  
  // Settings page navigation
  function showSettingsPage(pageId) {
    // Hide all pages
    document.querySelectorAll('.settings-page').forEach(page => {
      page.classList.remove('active');
    });
    
    // Remove active class from all nav buttons
    navBtns.forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected page and activate button
    document.getElementById(pageId + 'Page').classList.add('active');
    document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
  }
  
  // Slider switch toggle function
  function toggleSlider(slider, setting) {
    const isActive = !slider.classList.contains('active');
    slider.classList.toggle('active', isActive);
    updateSetting(setting, isActive);
    
    // Handle special cases
    if (setting === 'randomMode') {
      randomRangeInputs.style.display = isActive ? 'flex' : 'none';
      // Update timer duration
      totalSec = getCurrentDuration();
      remaining = totalSec;
      render();
    }
  }

  // Convert hours, minutes, seconds to total seconds
  function timeToSeconds(hours, minutes, seconds) {
    return (hours * 3600) + (minutes * 60) + seconds;
  }

  // Format seconds to HH:MM:SS or MM:SS
  function fmt(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    if (hours > 0) {
      return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    } else {
      return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }
  }

  function getRandomDuration() {
    const minSeconds = timeToSeconds(settings.randomMinHours, settings.randomMinMinutes, settings.randomMinSeconds);
    const maxSeconds = timeToSeconds(settings.randomMaxHours, settings.randomMaxMinutes, settings.randomMaxSeconds);
    
    // Ensure both min and max are at least 1 second
    const actualMin = Math.max(1, Math.min(minSeconds, maxSeconds));
    const actualMax = Math.max(1, Math.max(minSeconds, maxSeconds));
    
    // If both are the same, return that value
    if (actualMin === actualMax) return actualMax;
    
    // Generate random seconds between min and max (inclusive)
    return Math.floor(Math.random() * (actualMax - actualMin + 1)) + actualMin;
  }

  function setLengthFromInput() {
    return timeToSeconds(
      Math.max(0, parseInt(hoursInp.value || '0', 10)),
      Math.max(0, parseInt(minsInp.value || '0', 10)),
      Math.max(0, parseInt(secsInp.value || '0', 10))
    );
  }

  // Load audio files from folders
  function loadAudioFiles() {
    try {
      const audio2Path = path.join(__dirname, 'sounds', 'Audio2');
      const audio3Path = path.join(__dirname, 'sounds', 'Audio3');
      const audio4Path = path.join(__dirname, 'sounds', 'Audio4');
      
      // Load folder contents
      audio2Files = fs.existsSync(audio2Path) ? fs.readdirSync(audio2Path).filter(file => file.endsWith('.mp3')) : [];
      audio3Files = fs.existsSync(audio3Path) ? fs.readdirSync(audio3Path).filter(file => file.endsWith('.mp3')) : [];
      audio4Files = fs.existsSync(audio4Path) ? fs.readdirSync(audio4Path).filter(file => file.endsWith('.mp3')) : [];
      
      console.log(`Loaded ${audio2Files.length} Audio2 files, ${audio3Files.length} Audio3 files, ${audio4Files.length} Audio4 files`);
      
      // Update UI status
      updateAudioStatus();
    } catch (error) {
      console.error('Error loading audio files:', error);
      audio2Files = [];
      audio3Files = [];
      audio4Files = [];
    }
  }
  
  // Update audio status displays
  function updateAudioStatus() {
    const audio1Status = document.getElementById('audio1Status');
    const audio2Status = document.getElementById('audio2Status');
    const audio3Status = document.getElementById('audio3Status');
    const audio4Status = document.getElementById('audio4Status');
    
    // Check if Audio1.mp3 exists
    const audio1Exists = fs.existsSync(path.join(__dirname, 'sounds', 'Audio1.mp3'));
    audio1Status.textContent = audio1Exists ? 'Current: Audio1.mp3' : 'No audio file found';
    
    audio2Status.textContent = `Current: ${audio2Files.length} files`;
    audio3Status.textContent = `Current: ${audio3Files.length} files`;
    audio4Status.textContent = `Current: ${audio4Files.length} files`;
    
    // Update drop zone appearance
    audio1DropZone.classList.toggle('has-files', audio1Exists);
    audio2DropZone.classList.toggle('has-files', audio2Files.length > 0);
    audio3DropZone.classList.toggle('has-files', audio3Files.length > 0);
    audio4DropZone.classList.toggle('has-files', audio4Files.length > 0);
  }

  // Initialize audio file lists
  loadAudioFiles();

  function render() { display.textContent = fmt(remaining); }

  function getCurrentDuration() {
    if (settings.randomMode) {
      return getRandomDuration();
    } else {
      const duration = setLengthFromInput();
      // Ensure minimum 1 second duration
      return Math.max(1, duration);
    }
  }

  function beep() {
    if (!settings.sound) return;
    
    console.log(`Playing audio sequence: ${settings.audioCount} audios`);
    playAudioSequence();
  }
  
  function playAudioSequence() {
    let currentAudio = 1;
    
    function playNextAudio() {
      if (currentAudio > settings.audioCount) {
        console.log('Audio sequence complete');
        return;
      }
      
      let audioElement = null;
      let audioPath = '';
      
      switch (currentAudio) {
        case 1:
          // Audio 1 - single file
          audioPath = path.join(__dirname, 'sounds', 'Audio1.mp3');
          if (fs.existsSync(audioPath)) {
            if (!audio1) {
              audio1 = new Audio();
            }
            audio1.src = 'sounds/Audio1.mp3';
            audio1.volume = masterVolume;
            audioElement = audio1;
          }
          break;
          
        case 2:
          // Audio 2 - random from folder
          if (audio2Files.length > 0) {
            const randomFile = audio2Files[Math.floor(Math.random() * audio2Files.length)];
            if (!audio2) {
              audio2 = new Audio();
            }
            audio2.src = `sounds/Audio2/${randomFile}`;
            audio2.volume = masterVolume;
            audioElement = audio2;
          }
          break;
          
        case 3:
          // Audio 3 - random from folder
          if (audio3Files.length > 0) {
            const randomFile = audio3Files[Math.floor(Math.random() * audio3Files.length)];
            if (!audio3) {
              audio3 = new Audio();
            }
            audio3.src = `sounds/Audio3/${randomFile}`;
            audio3.volume = masterVolume;
            audioElement = audio3;
          }
          break;
          
        case 4:
          // Audio 4 - random from folder
          if (audio4Files.length > 0) {
            const randomFile = audio4Files[Math.floor(Math.random() * audio4Files.length)];
            if (!audio4) {
              audio4 = new Audio();
            }
            audio4.src = `sounds/Audio4/${randomFile}`;
            audio4.volume = masterVolume;
            audioElement = audio4;
          }
          break;
      }
      
      if (audioElement) {
        console.log(`Playing audio ${currentAudio}`);
        audioElement.currentTime = 0;
        
        audioElement.onended = () => {
          currentAudio++;
          setTimeout(playNextAudio, 200); // Small delay between audios
        };
        
        audioElement.onerror = (e) => {
          console.error(`Error playing audio ${currentAudio}:`, e);
          currentAudio++;
          setTimeout(playNextAudio, 200);
        };
        
        audioElement.play().catch(e => {
          console.error(`Failed to play audio ${currentAudio}:`, e);
          currentAudio++;
          setTimeout(playNextAudio, 200);
        });
      } else {
        console.log(`No audio ${currentAudio} available, skipping`);
        currentAudio++;
        setTimeout(playNextAudio, 200);
      }
    }
    
    playNextAudio();
  }

  function notify() {
    if (!settings.notifications) return;
    if (Notification.permission === 'granted') {
      new Notification('Timer', { body: '10 minutes are up!' });
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(p => { if (p==='granted') new Notification('Timer ready'); });
    }
  }

  function tick() {
    remaining--;
    render();
    document.title = `${fmt(remaining)} — Timer`;
    if (remaining <= 0) {
      laps++;
      lapsEl.textContent = String(laps);
      beep(); notify();
      totalSec = getCurrentDuration(); // Get duration based on current mode
      remaining = totalSec; // auto-repeat with new time
      render();
    }
  }

  function start() {
    if (timer) return;
    // Use appropriate duration mode if starting fresh, otherwise keep current remaining time
    if (remaining === totalSec) {
      totalSec = getCurrentDuration();
      remaining = totalSec;
      render();
    }
    timer = setInterval(tick, 1000);
    startBtn.disabled = true;
    pauseBtn.disabled = false;
  }
  function pause() {
    if (!timer) return;
    clearInterval(timer); timer = null;
    startBtn.disabled = false;
    pauseBtn.disabled = true;
  }
  
  function stop() {
    pause();
    totalSec = getCurrentDuration();
    remaining = totalSec;
    render();
  }
  
  function reset() {
    pause();
    // Reset all settings to defaults
    settings.hours = 0;
    settings.minutes = 10;
    settings.seconds = 0;
    settings.randomMode = false;
    settings.randomMinHours = 0;
    settings.randomMinMinutes = 7;
    settings.randomMinSeconds = 0;
    settings.randomMaxHours = 0;
    settings.randomMaxMinutes = 12;
    settings.randomMaxSeconds = 0;
    settings.sound = true;
    settings.notify = false;
    settings.alwaysOnTop = false;
    settings.volume = 100;
    settings.theme = 'dark';
    
    applySettings();
    saveSettings();
    
    laps = 0;
    lapsEl.textContent = String(laps);
    // Reset timer
    totalSec = getCurrentDuration();
    remaining = totalSec;
    render();
  }
  
  function toggleSettings() {
    if (mainView.style.display === 'none') {
      // Show main view, hide settings
      mainView.style.display = 'block';
      settingsView.style.display = 'none';
    } else {
      // Show settings, hide main view
      mainView.style.display = 'none';
      settingsView.style.display = 'block';
    }
  }

  function updateSetting(key, value) {
    settings[key] = value;
    saveSettings();
  }
  
  function updateTimeSettings() {
    updateSetting('hours', parseInt(hoursInp.value || '0'));
    updateSetting('minutes', parseInt(minsInp.value || '0'));
    updateSetting('seconds', parseInt(secsInp.value || '0'));
  }
  
  function updateRandomRangeSettings() {
    updateSetting('randomMinHours', parseInt(randomMinHours.value || '0'));
    updateSetting('randomMinMinutes', parseInt(randomMinMinutes.value || '0'));
    updateSetting('randomMinSeconds', parseInt(randomMinSeconds.value || '0'));
    updateSetting('randomMaxHours', parseInt(randomMaxHours.value || '0'));
    updateSetting('randomMaxMinutes', parseInt(randomMaxMinutes.value || '0'));
    updateSetting('randomMaxSeconds', parseInt(randomMaxSeconds.value || '0'));
  }
  
  function onRandomModeChange() {
    const isRandom = settings.randomMode;
    randomRangeInputs.style.display = isRandom ? 'flex' : 'none';
    
    // Update timer duration
    totalSec = getCurrentDuration();
    remaining = totalSec;
    render();
  }
  
  function onVolumeChange() {
    const volume = parseInt(volumeSlider.value);
    updateSetting('volume', volume);
    masterVolume = volume / 100;
    volumeDisplay.textContent = volume + '%';
  }
  
  function onThemeChange() {
    const theme = themeSelector.value;
    updateSetting('theme', theme);
    document.body.className = theme === 'dark' ? '' : `theme-${theme}`;
  }
  
  async function onAlwaysOnTopChange() {
    const enabled = alwaysOnTopCb.checked;
    updateSetting('alwaysOnTop', enabled);
    if (window.electronAPI) {
      await window.electronAPI.setAlwaysOnTop(enabled);
    }
  }
  
  async function openSoundsFolder() {
    if (window.electronAPI) {
      try {
        await window.electronAPI.openSoundsFolder();
      } catch (error) {
        console.error('Failed to open sounds folder:', error);
      }
    }
  }

  // Initialize
  loadSettings(); // Load saved settings first
  loadAudioFiles();
  updateDropZoneStatus(); // Update drop zone visual status
  
  // wire up
  totalSec = getCurrentDuration(); // Initialize with appropriate duration
  remaining = totalSec;
  render();
  
  // Time input event listeners
  hoursInp.addEventListener('change', () => {
    updateTimeSettings();
    if (!randomModeCb.checked) {
      totalSec = setLengthFromInput();
      remaining = totalSec;
      render();
    }
  });
  
  minsInp.addEventListener('change', () => {
    updateTimeSettings();
    if (!randomModeCb.checked) {
      totalSec = setLengthFromInput();
      remaining = totalSec;
      render();
    }
  });
  
  secsInp.addEventListener('change', () => {
    updateTimeSettings();
    if (!randomModeCb.checked) {
      totalSec = setLengthFromInput();
      remaining = totalSec;
      render();
    }
  });
  
  // Random range event listeners
  randomMinHours.addEventListener('change', updateRandomRangeSettings);
  randomMinMinutes.addEventListener('change', updateRandomRangeSettings);
  randomMinSeconds.addEventListener('change', updateRandomRangeSettings);
  randomMaxHours.addEventListener('change', updateRandomRangeSettings);
  randomMaxMinutes.addEventListener('change', updateRandomRangeSettings);
  randomMaxSeconds.addEventListener('change', updateRandomRangeSettings);
  
  volumeSlider.addEventListener('input', onVolumeChange);
  themeSelector.addEventListener('change', onThemeChange);
  audioCountSelector.addEventListener('change', (e) => {
    settings.audioCount = parseInt(e.target.value);
    localStorage.setItem('intervalTimerSettings', JSON.stringify(settings));
  });

  // Navigation event handlers
  navBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const pageId = btn.dataset.page;
      showSettingsPage(pageId);
    });
  });
  
  // Slider switch event handlers
  randomModeSwitch.addEventListener('click', () => {
    toggleSlider(randomModeSwitch, 'randomMode');
  });
  
  soundSwitch.addEventListener('click', () => {
    toggleSlider(soundSwitch, 'sound');
  });
  
  notifySwitch.addEventListener('click', () => {
    toggleSlider(notifySwitch, 'notifications');
  });
  
  alwaysOnTopSwitch.addEventListener('click', () => {
    toggleSlider(alwaysOnTopSwitch, 'alwaysOnTop');
    // Also call the IPC handler
    if (window.electronAPI) {
      window.electronAPI.setAlwaysOnTop(settings.alwaysOnTop);
    }
  });
  openSoundsFolderBtn.addEventListener('click', openSoundsFolder);
  restoreBackupBtn.addEventListener('click', async () => {
    if (confirm('This will restore the original audio files and delete any custom files you\'ve added. Continue?')) {
      try {
        const result = await window.electronAPI.restoreBackup();
        if (result.success) {
          showNotification('Backup restored successfully!');
          updateDropZoneStatus();
        } else {
          alert('Error restoring backup: ' + result.error);
        }
      } catch (error) {
        console.error('Error restoring backup:', error);
        alert('Error restoring backup. Please try again.');
      }
    }
  });
  
  startBtn.addEventListener('click', start);
  pauseBtn.addEventListener('click', pause);
  stopBtn.addEventListener('click', stop);
  resetBtn.addEventListener('click', reset);
  settingsBtn.addEventListener('click', toggleSettings);
  testAudioBtn.addEventListener('click', () => {
    beep(); // Test the audio sequence
  });

  // Drag-and-drop event handlers
  function setupDropZone(dropZone, audioNumber) {
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      
      const files = Array.from(e.dataTransfer.files);
      const audioFiles = files.filter(file => file.type.startsWith('audio/'));
      
      if (audioFiles.length === 0) {
        alert('Please drop audio files only (.mp3, .wav, .ogg, etc.)');
        return;
      }
      
      // Handle the files
      await handleAudioFileDrop(audioFiles, audioNumber);
      updateDropZoneStatus();
    });
  }
  
  // Setup drop zones
  setupDropZone(audio1DropZone, 1);
  setupDropZone(audio2DropZone, 2);
  setupDropZone(audio3DropZone, 3);
  setupDropZone(audio4DropZone, 4);
  
  // Audio file drop handler
  async function handleAudioFileDrop(files, audioNumber) {
    try {
      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const fileName = file.name;
        
        // For audio 1, replace the single file
        if (audioNumber === 1) {
          // Save as Audio1.mp3
          await window.electronAPI.saveAudioFile(arrayBuffer, fileName, 1);
          showNotification(`Audio 1 updated: ${fileName}`);
        } else {
          // For audio 2-4, add to the folder
          await window.electronAPI.saveAudioFile(arrayBuffer, fileName, audioNumber);
          showNotification(`Added to Audio ${audioNumber}: ${fileName}`);
        }
      }
    } catch (error) {
      console.error('Error handling audio files:', error);
      alert('Error saving audio files. Please try again.');
    }
  }
  
  // Show notification
  function showNotification(message) {
    // Create a simple toast notification
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // Update drop zone visual status
  async function updateDropZoneStatus() {
    try {
      // For now, just show default status - we could add an IPC call to check files
      audio1DropZone.querySelector('.drop-text').textContent = 'Drop Audio 1 file here\n(replaces current file)';
      audio2DropZone.querySelector('.drop-text').textContent = 'Drop Audio 2 files here\n(adds to folder)';
      audio3DropZone.querySelector('.drop-text').textContent = 'Drop Audio 3 files here\n(adds to folder)';
      audio4DropZone.querySelector('.drop-text').textContent = 'Drop Audio 4 files here\n(adds to folder)';
    } catch (error) {
      console.error('Error updating drop zone status:', error);
    }
  }

  // Initialize audio elements on first user interaction
  window.addEventListener('click', () => {
    if (!startAudio && soundCb.checked) {
      startAudio = document.getElementById('startSound');
      reasonAudio = document.getElementById('reasonSound');
      punishmentAudio = document.getElementById('punishmentSound');
      
      // Set initial volume
      startAudio.volume = masterVolume;
      reasonAudio.volume = masterVolume;
      punishmentAudio.volume = masterVolume;
    }
  }, { once: true });
})();
</script>
</body>
</html>
